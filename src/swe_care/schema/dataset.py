from dataclasses import dataclass
from typing import Any

from dataclasses_json import dataclass_json


@dataclass_json
@dataclass
class ResolvedIssue:
    """Schema for resolved issue instances."""

    number: int
    title: str
    body: str


@dataclass_json
@dataclass
class IssueResolvingTaskMetadata:
    """Schema for metadata instances."""

    problem_domain: str | None
    """The problem domain"""
    difficulty: str | None
    """The task difficulty of the pull request"""


@dataclass_json
@dataclass
class IssueResolvingTaskInstance:
    """Schema for Issue Resolving task instances."""

    instance_id: str
    repo: str
    language: str
    pull_number: int
    title: str
    body: str
    created_at: str
    problem_statement: str
    hints_text: str
    resolved_issues: list[ResolvedIssue]
    base_commit: str
    patch: str
    test_patch: str
    env_setup_config: dict[str, Any]
    FAIL_TO_PASS: list[str]
    PASS_TO_PASS: list[str]
    version: str
    metadata: IssueResolvingTaskMetadata


@dataclass_json
@dataclass
class CodeReviewTaskMetadata:
    """Schema for code review metadata instances."""

    problem_domain: str | None
    """The problem domain"""
    difficulty: str | None
    """The task difficulty of the pull request"""
    estimated_review_effort: int | None
    """The estimated review effort of the pull request between 1 and 5"""


@dataclass_json
@dataclass
class ReferenceReviewComment:
    """Schema for reference review comment instances."""

    text: str
    """The text of the review comment"""
    path: str
    """The path of the review comment"""
    diff_hunk: str | None
    """The diff hunk of the review comment"""
    line: int | None
    """The line number of the review comment"""
    start_line: int | None
    """The start line number of the review comment"""
    original_line: int | None
    """The original line number of the review comment"""
    original_start_line: int | None
    """The original start line number of the review comment"""


@dataclass_json
@dataclass
class CommitToReview:
    """Schema for commit to review instances."""

    head_commit: str
    head_commit_message: str
    patch_to_review: str


@dataclass_json
@dataclass
class CodeReviewTaskInstance:
    """Schema for Code Review task instances."""

    instance_id: str
    """A formatted instance identifier, usually as repo_owner__repo_name-PR-number@commit_sha_short"""
    repo: str
    """The repository owner/name identifier from GitHub"""
    language: str
    """The main programming language of the repo"""
    pull_number: int
    """Number of PR this task instance is from"""
    title: str
    """The PR title"""
    body: str
    """The PR body"""
    created_at: str
    """The creation date of the pull request"""
    problem_statement: str
    """The issue(s) title and body"""
    hints_text: str
    """Comments made on the issue(s) prior to the creation of the commit to review of the solution PR."""
    resolved_issues: list[ResolvedIssue]
    """The resolved issues of the pull request"""
    base_commit: str
    """The commit hash of the repository representing the HEAD of the repository before the solution PR is applied."""
    commit_to_review: CommitToReview
    """The commit to review of the pull request"""
    reference_review_comments: list[ReferenceReviewComment]
    """The reference review comments of the commit to review"""
    merged_commit: str
    """The merged commit of the pull request"""
    merged_patch: str
    """The gold patch, the patch generated by the PR, that resolved the issue"""
    metadata: CodeReviewTaskMetadata

    @classmethod
    def generate_instance_id(cls, repo: str, pull_number: int, commit: str) -> str:
        """Generate an instance ID from repo, pull number, and commit.

        Args:
            repo: The repository owner/name identifier from GitHub
            pull_number: Number of PR this task instance is from
            commit: The commit hash (will be shortened to first 7 characters)

        Returns:
            A formatted instance identifier as repo_owner__repo_name-PR-number@commit_sha_short
        """
        repo_formatted = repo.replace("/", "__")
        commit_short = commit[:7]
        return f"{repo_formatted}-{pull_number}@{commit_short}"

    @classmethod
    def parse_instance_id(cls, instance_id: str) -> tuple[str, int, str]:
        """Parse an instance ID into repo, pull number, and commit.

        Args:
            instance_id: The instance ID to parse

        Returns:
            A tuple of repo, pull number, and commit

        Raises:
            ValueError: If the instance ID format is invalid
        """
        if "@" not in instance_id:
            raise ValueError(
                f"Invalid instance ID format: {instance_id}. Expected format: repo_owner__repo_name-PR-number@commit_sha_short"
            )

        repo_pr_part, commit = instance_id.split("@", 1)

        if "-" not in repo_pr_part:
            raise ValueError(
                f"Invalid instance ID format: {instance_id}. Expected format: repo_owner__repo_name-PR-number@commit_sha_short"
            )

        repo_formatted, pull_number_str = repo_pr_part.rsplit("-", 1)

        try:
            pull_number = int(pull_number_str)
        except ValueError:
            raise ValueError(f"Invalid pull number in instance ID: {instance_id}")

        repo = repo_formatted.replace("__", "/")

        return repo, pull_number, commit
